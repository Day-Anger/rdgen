name: Custom Windows Client Generator
run-name: Custom Windows Client Generator
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'version to buld'
        required: true
        default: ''
        type: string
      zip_url:
        description: 'url to zip of json'
        required: true
        default: ''
        type: string


env:
  SCITER_RUST_VERSION: "1.75" # https://github.com/rustdesk/rustdesk/discussions/7503, also 1.78 has ABI change which causes our sciter version not working, https://blog.rust-lang.org/2024/03/30/i128-layout-update.html
  RUST_VERSION: "1.75" # sciter failed on m1 with 1.78 because of https://blog.rust-lang.org/2024/03/30/i128-layout-update.html
  CARGO_NDK_VERSION: "3.1.2"
  SCITER_ARMV7_CMAKE_VERSION: "3.29.7"
  SCITER_NASM_DEBVERSION: "2.15.05-1"
  LLVM_VERSION: "15.0.6"
  FLUTTER_VERSION: "3.24.5"
  ANDROID_FLUTTER_VERSION: "3.24.5"
  # for arm64 linux because official Dart SDK does not work
  FLUTTER_ELINUX_VERSION: "3.16.9"
  TAG_NAME: "${{ inputs.upload-tag }}"
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
  # vcpkg version: 2024.07.12
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"
  ARMV7_VCPKG_COMMIT_ID: "6f29f12e82a8293156836ad81cc9bf5af41fe836"
  VERSION: "${{ inputs.version }}"
  NDK_VERSION: "r27c"
  #signing keys env variable checks
  ANDROID_SIGNING_KEY: "${{ secrets.ANDROID_SIGNING_KEY }}"
  MACOS_P12_BASE64: "${{ secrets.MACOS_P12_BASE64 }}"
  UPLOAD_ARTIFACT: 'true'
  SIGN_BASE_URL: "${{ secrets.SIGN_BASE_URL }}"
  STATUS_URL: "${{ secrets.GENURL }}/updategh"


jobs:
  generate-bridge:
    uses: ./.github/workflows/bridge.yml
    with:
      version: ${{ inputs.version }}

  build-RustDeskTempTopMostWindow:
    uses: ./.github/workflows/third-party-RustDeskTempTopMostWindow.yml
    with:
      upload-artifact: true
      target: windows-2022
      configuration: Release
      platform: x64
      target_version: Windows10
    secrets: inherit
    strategy:
      fail-fast: false

  build-for-windows-flutter:
    name: Build Windows
    needs: [build-RustDeskTempTopMostWindow, generate-bridge]
    runs-on: ${{ matrix.job.os }}
    strategy:
      fail-fast: false
      matrix:
        job:
          # - { target: i686-pc-windows-msvc        , os: windows-2022                  }
          # - { target: x86_64-pc-windows-gnu       , os: windows-2022                  }
          - {
              target: x86_64-pc-windows-msvc,
              os: windows-2022,
              arch: x86_64,
              vcpkg-triplet: x64-windows-static,
            }
          # - { target: aarch64-pc-windows-msvc, os: windows-2022, arch: aarch64 }
    steps:
      - name: install python deps
        run: |
          pip install requests pyzipper

      - name: Download, Decrypt, and Mask
        shell: python
        env:
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "utf-8"
        run: |
          import sys
          import requests
          import pyzipper
          import io
          import os
          import json
          import time

          # Полная замена стандартного вывода на UTF-8 с игнорированием ошибок кодировки
          sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
          sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

          for attempt in range(5):
            try:
              print(f"Downloading secrets (Attempt {attempt + 1})...")
              r = requests.get('${{ fromJson(inputs.zip_url).url }}/get_zip?filename=${{ fromJson(inputs.zip_url).file }}', timeout=60)
              r.raise_for_status()
              break
            except (requests.exceptions.RequestException, requests.exceptions.Timeout) as e:
              if attempt < 4:
                print(f"Timeout/Error occurred: {e}. Retrying in 5 seconds...")
                time.sleep(30)
              else:
                print("Max retries reached. Failing.")
                raise e

          try:
            with pyzipper.AESZipFile(io.BytesIO(r.content)) as zf:
              zf.setpassword('${{ secrets.ZIP_PASSWORD }}'.encode())
              with zf.open('secrets.json') as f:
                secrets = json.load(f)
          except Exception as e:
            print(f"Error: Could not decrypt ZIP. Check if password matches. {e}")
            exit(1)

          with open(os.environ['GITHUB_ENV'], 'a', encoding='utf-8') as env_file:
            for key, value in secrets.items():
              print(f"::add-mask::{value}")
              env_file.write(f"{key}={value}\n")

          print("Secrets loaded into environment.")

      - name: Finalize and Cleanup zip/json
        if: always() # Run even if previous steps fail
        continue-on-error: true
        uses: fjogeleit/http-request-action@v1
        with:
          url: "${{ secrets.GENURL }}/cleanzip"
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}"}'

      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v6
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Set rdgen value
        if: ${{ env.rdgen == 'true' }}
        run: |
          echo "STATUS_URL=${{ secrets.GENURL }}/updategh" >> $env:GITHUB_ENV

      - name: Set rdgen value
        if: ${{ env.rdgen == 'false' }}
        run: |
          echo "STATUS_URL=${{ env.apiServer }}/api/updategh" >> $env:GITHUB_ENV

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "5% complete"}'

      - name: Checkout source code
        if: ${{ env.VERSION != 'master' }}
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          ref: refs/tags/${{ env.VERSION }}
          submodules: recursive

      - name: Checkout source code
        if: ${{ env.VERSION == 'master' }}
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          submodules: recursive

      - name: Restore bridge files
        uses: actions/download-artifact@master
        with:
          name: bridge-artifact
          path: ./

      # Кэширование ImageMagick
      - name: Cache ImageMagick
        id: cache-imagemagick
        uses: actions/cache@v3
        with:
          path: C:\Program Files\ImageMagick*
          key: imagemagick-windows-v1

      # Установка (только если кэша нет)
      - name: Install ImageMagick on Windows
        if: steps.cache-imagemagick.outputs.cache-hit != 'true'
        run: choco install -y imagemagick.app --no-progress

      # Добавление в PATH (нужно всегда)
      - name: Add ImageMagick to PATH
        run: |
          Get-ChildItem -Path "$env:ProgramFiles" | % { $_.FullName } | Select-String -Pattern "[\/\\]ImageMagick[^\/\\]*$" | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8

      # - name: Install ImageMagick on Windows
      #   run: |
      #     choco install -y imagemagick.app --no-progress
      #     Get-ChildItem -Path "${env:ProgramFiles}" | % { $_.FullName } | Select-String -Pattern "[\/\\]ImageMagick[^\/\\]*$" | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8

      - name: fix flutter_gpu_texture_renderer (fixed in master rustdesk)
        shell: bash
        run: |
          sed -i -e 's|2ded7f146437a761ffe6981e2f742038f85ca68d|08a471bb8ceccdd50483c81cdfa8b81b07b14b87|' ./flutter/pubspec.lock
          sed -i -e 's|2ded7f146437a761ffe6981e2f742038f85ca68d|08a471bb8ceccdd50483c81cdfa8b81b07b14b87|' ./flutter/pubspec.yaml

      - name: change appname to custom
        if: env.appname != 'rustdesk'
        shell: python
        env:
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "utf-8"
          APPNAME: ${{ env.appname }}
          FILENAME: ${{ env.filename }}
          COMPNAME: ${{ env.compname }}
        run: |
          import os
          import sys
          import glob
          import io

          sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
          sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

          appname = os.environ.get('APPNAME', '')
          filename = os.environ.get('FILENAME', '')
          compname = os.environ.get('COMPNAME', '')

          if not appname:
              print('Error: APPNAME is not set')
              sys.exit(1)

          print(f'Patching AppName: {appname}, Filename: {filename}')

          # --- ПОДГОТОВКА ЭКРАНИРОВАНИЯ ---
          # 1. Для кода (Rust, TOML): кавычка \" -> \\\"
          appname_code = appname.replace('\"', '\\\"')
          compname_code = compname.replace('\"', '\\\"') if compname else ''

          # 2. Для RC файлов (Windows): кавычка \" -> \"\"
          appname_rc = appname.replace('\"', '\"\"')
          filename_rc = filename.replace('\"', '\"\"')

          # --- ФУНКЦИЯ ПАТЧИНГА ---
          def patch_file(path, replacements):
              if not os.path.exists(path):
                  print(f'Warning: File not found: {path}')
                  return
              try:
                  # Читаем всегда как utf-8-sig (совместимо с BOM от предыдущего шага)
                  with open(path, 'r', encoding='utf-8-sig') as f:
                      content = f.read()

                  # Если это Runner.rc, проверяем наличие магии для UTF-8
                  if path.endswith('Runner.rc') and '#pragma code_page' not in content:
                      content = '#pragma code_page(65001)\n' + content
                      print(f'Added #pragma code_page(65001) to {path}')

                  original_content = content
                  for search, replace in replacements:
                      content = content.replace(search, replace)

                  if content != original_content:
                      # Пишем обратно с BOM (utf-8-sig)
                      with open(path, 'w', encoding='utf-8-sig') as f:
                          f.write(content)
                      print(f'Updated: {path}')
              except Exception as e:
                  print(f'Error processing {path}: {e}')
                  sys.exit(1)

          # 1. Cargo.toml (Root и Portable)
          # Используем appname_code (с экранированием \")
          cargo_replacements = [
              ('description = \"RustDesk Remote Desktop\"', f'description = \"{appname_code}\"'),
              ('ProductName = \"RustDesk\"', f'ProductName = \"{appname_code}\"'),
              ('FileDescription = \"RustDesk Remote Desktop\"', f'FileDescription = \"{appname_code}\"'),
              ('OriginalFilename = \"rustdesk.exe\"', f'OriginalFilename = \"{appname_code}.exe\"'),
          ]

          patch_file('./Cargo.toml', cargo_replacements)
          patch_file('./libs/portable/Cargo.toml', cargo_replacements)

          # 2. Runner.rc
          # Используем appname_rc (с экранированием \"\")
          runner_replacements = [
              ('\"RustDesk Remote Desktop\"', f'\"{appname_rc}\"'),
              ('VALUE \"InternalName\", \"rustdesk\"', f'VALUE \"InternalName\", \"{appname_rc}\"'),
              ('\"rustdesk.exe\"', f'\"{filename_rc}\"'),
              ('\"RustDesk\"', f'\"{appname_rc}\"'),
          ]
          patch_file('./flutter/windows/runner/Runner.rc', runner_replacements)

          # 3. Языковые файлы и Лицензия
          lang_files = glob.glob('./src/lang/**/*.rs', recursive=True)
          lang_files.append('./res/msi/Package/License.rtf')

          for file_path in lang_files:
              replacements = []

              # Определяем, какую версию имени использовать (для кода или сырую)
              is_rust = file_path.endswith('.rs')
              target_compname = compname_code if is_rust else compname
              target_appname = appname_code if is_rust else appname

              # Логика: Сначала меняем RustDesk на Компанию (если задана), остатки на Имя Приложения
              if target_compname:
                  replacements.append(('RustDesk', target_compname))

              replacements.append(('RustDesk', target_appname))

              patch_file(file_path, replacements)

      - name: fix registry if appname has a space
        if: contains(env.appname, ' ')
        continue-on-error: true
        shell: bash
        run: |
          #./src/platform/windows.rs
          sed -i -e 's|reg add {}|reg add \\\"{}\\\"|' ./src/platform/windows.rs
          sed -i -e 's|reg add HKEY_CLASSES_ROOT\\\\.{ext} /f|reg add \\\"HKEY_CLASSES_ROOT\\\\.{ext}\\\" /f|' ./src/platform/windows.rs
          sed -i -e 's|reg add HKEY_CLASSES_ROOT\\\\.{ext}\\\\DefaultIcon /f|reg add \\\"HKEY_CLASSES_ROOT\\\\.{ext}\\\\DefaultIcon\\\" /f|' ./src/platform/windows.rs
          sed -i -e 's|reg add HKEY_CLASSES_ROOT\\\\.{ext}\\\\shell /f|reg add \\\"HKEY_CLASSES_ROOT\\\\.{ext}\\\\shell\\\" /f|' ./src/platform/windows.rs
          sed -i -e 's|reg add HKEY_CLASSES_ROOT\\\\.{ext}\\\\shell\\\\open /f|reg add \\\"HKEY_CLASSES_ROOT\\\\.{ext}\\\\shell\\\\open\\\" /f|' ./src/platform/windows.rs
          sed -i -e 's|reg add HKEY_CLASSES_ROOT\\\\.{ext}\\\\shell\\\\open\\\\command|reg add \\\"HKEY_CLASSES_ROOT\\\\.{ext}\\\\shell\\\\open\\\\command\\\"|' ./src/platform/windows.rs
          sed -i -e 's|reg add HKEY_CLASSES_ROOT\\\\{ext} /f|reg add \\\"HKEY_CLASSES_ROOT\\\\{ext}\\\" /f|' ./src/platform/windows.rs
          sed -i -e 's|reg add HKEY_CLASSES_ROOT\\\\{ext}\\\\shell /f|reg add \\\"HKEY_CLASSES_ROOT\\\\{ext}\\\\shell\\\" /f|' ./src/platform/windows.rs
          sed -i -e 's|reg add HKEY_CLASSES_ROOT\\\\{ext}\\\\shell\\\\open /f|reg add \\\"HKEY_CLASSES_ROOT\\\\{ext}\\\\shell\\\\open\\\" /f|' ./src/platform/windows.rs
          sed -i -e 's|reg add HKEY_CLASSES_ROOT\\\\{ext}\\\\shell\\\\open\\\\command /f|reg add \\\"HKEY_CLASSES_ROOT\\\\{ext}\\\\shell\\\\open\\\\command\\\" /f|' ./src/platform/windows.rs
          sed -i -e 's|{subkey}|\\\"{subkey}\\\"|' ./src/platform/windows.rs
          sed -i -e 's|reg delete HKEY_CLASSES_ROOT\\\\.{ext} /f|reg delete \\\"HKEY_CLASSES_ROOT\\\\.{ext}\\\" /f|' ./src/platform/windows.rs
          sed -i -e 's|reg delete HKEY_CLASSES_ROOT\\\\{ext} /f|reg delete \\\"HKEY_CLASSES_ROOT\\\\{ext}\\\" /f|' ./src/platform/windows.rs

      - name: change company name
        if: env.compname != 'Purslane Ltd'
        shell: python
        env:
          PYTHONUTF8: 1
          PYTHONIOENCODING: utf-8
          COMPNAME: ${{ env.compname }}
        run: |
          import os
          import io
          import sys
          import re
          import glob
          import html

          # ЖЕЛЕЗОБЕТОННЫЙ способ форсировать UTF-8 на Windows-раннере
          sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
          sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

          compname = os.environ.get('COMPNAME')
          if not compname:
              print('Error: COMPNAME is empty')
              sys.exit(1)

          print(f'Patching with company name: {compname}')

          # --- ПОДГОТОВКА ЭКРАНИРОВАНИЯ ---
          # 1. Для кода (Rust/Dart): кавычка \" -> \\\"
          compname_code = compname.replace('\"', '\\\"')
          # 2. Для RC (Windows): кавычка \" -> \"\"
          compname_rc = compname.replace('\"', '\"\"')
          # 3. Для RTF: экранируем слэши
          compname_rtf = compname.replace('\\', '\\\\')
          # 4. Для XML/WiX атрибутов (чтобы кавычки внутри не ломали структуру)
          compname_xml = html.escape(compname, quote=True)

          # --- ФУНКЦИЯ ПАТЧИНГА ---
          def patch_file(path, search, replace):
              if not os.path.exists(path):
                  print(f'Warning: File not found: {path}')
                  return
              try:
                  # Читаем с utf-8-sig (чтобы не было проблем с BOM)
                  with open(path, 'r', encoding='utf-8-sig') as f:
                      content = f.read()

                  # --- МАГИЯ ДЛЯ RC.EXE ---
                  # Если это .rc файл, добавляем директиву кодировки UTF-8
                  if path.endswith('.rc') and '#pragma code_page(65001)' not in content:
                      content = '#pragma code_page(65001)\n' + content
                      print(f'Added UTF-8 pragma to {path}')

                  if search in content:
                      new_content = content.replace(search, replace)
                      # СОХРАНЯЕМ КАК UTF-8 С BOM (utf-8-sig)
                      with open(path, 'w', encoding='utf-8-sig') as f:
                          f.write(new_content)
                      print(f'Updated: {path}')
              except Exception as e:
                  print(f'Error patching {path}: {e}')
                  sys.exit(1)

          # 1. Обычные файлы
          files_code = [
              ('./flutter/lib/desktop/pages/desktop_setting_page.dart', 'Purslane Ltd'),
              ('./Cargo.toml', 'Purslane Ltd'),
              ('./libs/portable/Cargo.toml', 'Purslane Ltd'),
          ]
          for path, search in files_code:
              patch_file(path, search, compname_code)

          # 2. Языковые файлы Rust
          for path in glob.glob('./src/lang/**/*.rs', recursive=True):
              patch_file(path, 'RustDesk', compname_code)

          # 3. Лицензия
          patch_file('./res/msi/Package/License.rtf', 'Purslane Ltd', compname_rtf)

          # 4. Runner.rc (Copyright)
          runner_rc = './flutter/windows/runner/Runner.rc'
          if os.path.exists(runner_rc):
              with open(runner_rc, 'r', encoding='utf-8-sig') as f:
                  content = f.read()

              # Добавляем pragma, если нет
              if '#pragma code_page(65001)' not in content:
                  content = '#pragma code_page(65001)\n' + content
                  print('Added UTF-8 pragma to Runner.rc')

              # Формируем Copyright
              new_copyright = f'Copyright \u00A9 2025 {compname_rc}. All rights reserved.'

              # Regex замена
              pattern = r'Copyright\s+(?:\u00A9|\(c\))\s+2025\s+Purslane\s+Ltd\.?\s+All\s+rights\s+reserved\.?'
              new_content, count = re.subn(pattern, new_copyright, content, flags=re.IGNORECASE)

              # Fallback
              if 'Purslane Ltd' in new_content:
                   new_content = new_content.replace('Purslane Ltd', compname_rc)
                   count += 1

              if count > 0 or '#pragma' in content:
                  with open(runner_rc, 'w', encoding='utf-8-sig') as f:
                      f.write(new_content)
                  print(f'Updated: {runner_rc}')
          # 5. Файлы MSI (preprocess.py требует XML-безопасную строку)
          msi_configs = [
              ('./res/msi/preprocess.py', 'PURSLANE'),
              ('./res/msi/preprocess.py', 'Purslane Ltd'),
          ]
          for path, search in msi_configs:
              patch_file(path, search, compname_xml)

          # --- ПАТЧИНГ PREPROCESS.PY (ИНЪЕКЦИЯ UTF-8) ---
          preprocess_path = './res/msi/preprocess.py'
          if os.path.exists(preprocess_path):
              with open(preprocess_path, 'r', encoding='utf-8-sig') as f:
                  content = f.read()

              # Вставляем настройку потоков сразу после import sys
              if "sys.stdout = io.TextIOWrapper" not in content:
                  # Добавляем import io и перенастройку
                  injection = "\nimport io; sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace'); sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')"
                  content = content.replace("import sys", "import sys" + injection)

                  with open(preprocess_path, 'w', encoding='utf-8-sig') as f:
                      f.write(content)
                  print(f'Successfully injected UTF-8 fix into {preprocess_path}')

      - name: change url to custom
        if: env.urlLink != 'https://rustdesk.com'
        continue-on-error: true
        shell: bash
        run: |
          sed -i -e 's|Homepage: https://rustdesk.com|Homepage: ${{ env.urlLink }}|' ./build.py
          sed -i -e "s|launchUrl(Uri.parse('https://rustdesk.com'));|launchUrl(Uri.parse('${{ env.urlLink }}'));|" ./flutter/lib/common.dart
          sed -i -e "s|launchUrlString('https://rustdesk.com');|launchUrlString('${{ env.urlLink }}');|" ./flutter/lib/desktop/pages/desktop_setting_page.dart
          sed -i -e "s|launchUrlString('https://rustdesk.com/privacy.html')|launchUrlString('${{ env.urlLink }}/privacy.html')|" ./flutter/lib/desktop/pages/desktop_setting_page.dart
          sed -i -e "s|const url = 'https://rustdesk.com/';|const url = '${{ env.urlLink }}';|" ./flutter/lib/mobile/pages/settings_page.dart
          sed -i -e "s|launchUrlString('https://rustdesk.com/privacy.html')|launchUrlString('${{ env.urlLink }}/privacy.html')|" ./flutter/lib/mobile/pages/settings_page.dart
          sed -i -e "s|https://rustdesk.com/privacy.html|${{ env.urlLink }}/privacy.html|" ./flutter/lib/desktop/pages/install_page.dart
          sed -i -e "s|rustdesk.com|${{ env.urlLink }}|" ./res/msi/Package/License.rtf

      - name: change download link to custom
        if: env.downloadLink != 'https://rustdesk.com/download'
        continue-on-error: true
        shell: bash
        run: |
          sed -i -e 's|https://rustdesk.com/download|${{ env.downloadLink }}|' ./flutter/lib/desktop/pages/desktop_home_page.dart
          sed -i -e 's|https://rustdesk.com/download|${{ env.downloadLink }}|' ./flutter/lib/mobile/pages/connection_page.dart
          sed -i -e 's|https://rustdesk.com/download|${{ env.downloadLink }}|' ./src/ui/index.tis

      - name: set server, serverPort, key, and apiserver
        shell: bash
        # Передаем секреты и переменные как ENV переменные Bash,
        # чтобы избежать проблем со спецсимволами при подстановке
        env:
          SERVER_DOMAIN: ${{ env.server }}
          SERVER_PORT_INPUT: ${{ env.serverPort }}
          SERVER_KEY: ${{ env.key }}
          API_SERVER: ${{ env.apiServer }}
        run: |
          # Проверка наличия файла перед началом (чтобы не гадать)
          if [ ! -f "./libs/hbb_common/src/config.rs" ]; then
            echo "Error: config.rs not found!"
            exit 1
          fi

          # Вычисляем порты
          SERVER_PORT=$SERVER_PORT_INPUT
          RELAY_PORT=$((SERVER_PORT + 1))
          WS_RENDEZVOUS_PORT=$((RELAY_PORT + 1))
          WS_RELAY_PORT=$((WS_RENDEZVOUS_PORT + 1))

          echo "Setting ports: $SERVER_PORT, $RELAY_PORT, $WS_RENDEZVOUS_PORT, $WS_RELAY_PORT"

          # Замены
          # Используем переменные окружения bash ($SERVER_DOMAIN), а не шаблоны GH Actions
          sed -i -e "s|rs-ny.rustdesk.com|$SERVER_DOMAIN|" ./libs/hbb_common/src/config.rs

          # Используем регулярное выражение (0-9)+, чтобы не зависеть от дефолтного порта 21116
          sed -i -e "s|pub const RENDEZVOUS_PORT: i32 = [0-9]\+;|pub const RENDEZVOUS_PORT: i32 = $SERVER_PORT;|" ./libs/hbb_common/src/config.rs
          sed -i -e "s|pub const RELAY_PORT: i32 = [0-9]\+;|pub const RELAY_PORT: i32 = $RELAY_PORT;|" ./libs/hbb_common/src/config.rs
          sed -i -e "s|pub const WS_RENDEZVOUS_PORT: i32 = [0-9]\+;|pub const WS_RENDEZVOUS_PORT: i32 = $WS_RENDEZVOUS_PORT;|" ./libs/hbb_common/src/config.rs
          sed -i -e "s|pub const WS_RELAY_PORT: i32 = [0-9]\+;|pub const WS_RELAY_PORT: i32 = $WS_RELAY_PORT;|" ./libs/hbb_common/src/config.rs

          # Замена ключа
          sed -i -e "s|OeVuKk5nlHiXp+APNn0Y3pC1Iwpwn44JGqrQCsWqmBw=|$SERVER_KEY|" ./libs/hbb_common/src/config.rs

          # Замена API сервера
          sed -i -e "s|https://admin.rustdesk.com|$API_SERVER|" ./src/common.rs

      - name: allow custom.txt
        continue-on-error: true
        run: |
          Invoke-WebRequest -Uri https://raw.githubusercontent.com/bryangerlach/rdgen/refs/heads/master/.github/patches/allowCustom.py -OutFile allowCustom.py
          python allowCustom.py
          # Remove Setup Server Tip
          Invoke-WebRequest -Uri https://raw.githubusercontent.com/bryangerlach/rdgen/refs/heads/master/.github/patches/removeSetupServerTip.diff -OutFile removeSetupServerTip.diff
          git apply removeSetupServerTip.diff

      # Кэширование LLVM
      - name: Cache LLVM
        id: cache-llvm
        uses: actions/cache@v3
        with:
          path: C:\Program Files\LLVM
          key: llvm-${{ env.LLVM_VERSION }}

      # Установка (использует кэш, если он есть)
      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: ${{ env.LLVM_VERSION }}
          cached: ${{ steps.cache-llvm.outputs.cache-hit }}

      # - name: Install LLVM and Clang
      #   uses: KyleMayes/install-llvm-action@v1
      #   with:
      #     version: ${{ env.LLVM_VERSION }}

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "10% complete"}'

      # 1. Установка Flutter с включенным кэшем
      - name: Install flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true # <--- ЭТО ВАЖНО: кэширует сам SDK Flutter

      # 2. Проверка кэша для кастомного движка
      - name: Cache Custom Flutter Engine
        id: cache-engine
        uses: actions/cache@v3
        with:
          path: windows-x64-release.zip
          # Если ссылка на движок поменяется, поменяйте v1 на v2, чтобы сбросить кэш
          key: custom-engine-windows-v1

      # 3. Скачивание (если нет в кэше) и замена
      - name: Replace engine with rustdesk custom flutter engine
        run: |
          flutter doctor -v
          flutter precache --windows

          # Проверяем, восстановился ли файл из кэша. Если нет — качаем.
          if (-not (Test-Path "windows-x64-release.zip")) {
              Write-Host "Cache miss: Downloading engine..."
              Invoke-WebRequest -Uri https://github.com/rustdesk/engine/releases/download/main/windows-x64-release.zip -OutFile windows-x64-release.zip
          } else {
              Write-Host "Cache hit: Using cached engine."
          }

          # Распаковка (Force перезаписывает, если папка есть)
          Expand-Archive -Path windows-x64-release.zip -DestinationPath windows-x64-release -Force

          # Перемещение файлов
          $destPath = "C:/hostedtoolcache/windows/flutter/stable-${{ env.FLUTTER_VERSION }}-x64/bin/cache/artifacts/engine/windows-x64-release/"
          # Создаем папку назначения на всякий случай, если precache не создал
          New-Item -ItemType Directory -Force -Path $destPath
          mv -Force windows-x64-release/* $destPath

      # 4. Патч (Ваш код без изменений)
      - name: Patch flutter
        shell: bash
        run: |
          cp .github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff $(dirname $(dirname $(which flutter)))
          cd $(dirname $(dirname $(which flutter)))
          [[ "3.24.5" == ${{env.FLUTTER_VERSION}} ]] && git apply flutter_3.24.4_dropdown_menu_enableFilter.diff

      # - name: Install flutter
      #   uses: subosito/flutter-action@v2.12.0 #https://github.com/subosito/flutter-action/issues/277
      #   with:
      #     channel: "stable"
      #     flutter-version: ${{ env.FLUTTER_VERSION }}

      # # https://github.com/flutter/flutter/issues/155685
      # - name: Replace engine with rustdesk custom flutter engine
      #   run: |
      #     flutter doctor -v
      #     flutter precache --windows
      #     Invoke-WebRequest -Uri https://github.com/rustdesk/engine/releases/download/main/windows-x64-release.zip -OutFile windows-x64-release.zip
      #     Expand-Archive -Path windows-x64-release.zip -DestinationPath windows-x64-release
      #     mv -Force windows-x64-release/*  C:/hostedtoolcache/windows/flutter/stable-${{ env.FLUTTER_VERSION }}-x64/bin/cache/artifacts/engine/windows-x64-release/

      # - name: Patch flutter
      #   shell: bash
      #   run: |
      #     cp .github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff $(dirname $(dirname $(which flutter)))
      #     cd $(dirname $(dirname $(which flutter)))
      #     [[ "3.24.5" == ${{env.FLUTTER_VERSION}} ]] && git apply flutter_3.24.4_dropdown_menu_enableFilter.diff

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.SCITER_RUST_VERSION }}
          targets: ${{ matrix.job.target }}
          components: "rustfmt"

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "15% complete"}'

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ matrix.job.os }}

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "20% complete"}'

      # Это сохранит уже скомпилированные библиотеки
      - name: Cache vcpkg installed artifacts
        uses: actions/cache@v3
        with:
          path: |
            C:\vcpkg\installed
            C:\Users\runneradmin\AppData\Local\vcpkg\archives
          # Ключ зависит от ОС, версии vcpkg и файла манифеста (списка библиотек)
          # Если вы поменяете vcpkg.json, кэш сбросится и соберется новый
          key: vcpkg-cache-${{ runner.os }}-${{ env.VCPKG_COMMIT_ID }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-cache-${{ runner.os }}-${{ env.VCPKG_COMMIT_ID }}-

      - name: Setup vcpkg with Github Actions binary cache
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: C:\vcpkg
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
          doNotCache: false

      - name: Install vcpkg dependencies
        env:
          VCPKG_DEFAULT_HOST_TRIPLET: ${{ matrix.job.vcpkg-triplet }}
        run: |
          if ! $VCPKG_ROOT/vcpkg \
            install \
            --triplet ${{ matrix.job.vcpkg-triplet }} \
            --x-install-root="$VCPKG_ROOT/installed"; then
            find "${VCPKG_ROOT}/" -name "*.log" | while read -r _1; do
              echo "$_1:"
              echo "======"
              cat "$_1"
              echo "======"
              echo ""
            done
            exit 1
          fi
          head -n 100 "${VCPKG_ROOT}/buildtrees/ffmpeg/build-${{ matrix.job.vcpkg-triplet }}-rel-out.log" || true
        shell: bash

      - name: magick stuff
        if: ${{ env.iconlink_url != 'false' }}
        continue-on-error: true
        run: |
          Invoke-WebRequest -Uri ${{ env.iconlink_url }}/get_png?filename=${{ env.iconlink_file }}"&"uuid=${{ env.iconlink_uuid }} -OutFile ./res/iconx.png
          mv ./res/icon.ico ./res/icon.ico.bak
          mv ./res/icon.png ./res/icon.png.bak
          mv ./res/tray-icon.ico ./res/tray-icon.ico.bak
          mv ./res/iconx.png ./res/icon.png
          mv ./res/32x32.png ./res/32x32.png.bak
          mv ./res/64x64.png ./res/64x64.png.bak
          mv ./res/128x128.png ./res/128x128.png.bak
          mv ./res/128x128@2x.png ./res/128x128@2x.png.bak
          magick ./res/icon.png -define icon:auto-resize=256,64,48,32,16 ./res/icon.ico
          cp ./res/icon.ico ./res/tray-icon.ico
          magick ./res/icon.png -resize 32x32 ./res/32x32.png
          magick ./res/icon.png -resize 64x64 ./res/64x64.png
          magick ./res/icon.png -resize 128x128 ./res/128x128.png
          magick ./res/128x128.png -resize 200% ./res/128x128@2x.png


      - name: ui.rs icon
        if: ${{ env.iconlink_url != 'false' }}
        continue-on-error: true
        shell: bash
        run: |
          cp ./src/ui.rs ./src/ui.rs.bak
          b64=$(base64 -w0 < ./res/icon.png)
          perl -0777 -pe "s|iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHL[A-Za-z0-9+/=]+|$b64|g" -i.bak ./src/ui.rs
          b64=""

      - name: fix connection delay
        continue-on-error: true
        if: ${{ env.delayFix == 'true' }}
        shell: bash
        run: |
          sed -i -e 's|!key.is_empty()|false|' ./src/client.rs

      - name: add cycle monitors to toolbar
        continue-on-error: true
        if: env.cycleMonitor == 'true'
        run: |
          Invoke-WebRequest -Uri https://raw.githubusercontent.com/bryangerlach/rdgen/refs/heads/master/.github/patches/cycle_monitor.diff -OutFile cycle_monitor.diff
          git apply cycle_monitor.diff

      - name: use X for offline display instead of orange circle
        continue-on-error: true
        if: env.xOffline == 'true'
        run: |
          Invoke-WebRequest -Uri https://raw.githubusercontent.com/bryangerlach/rdgen/refs/heads/master/.github/patches/xoffline.diff -OutFile xoffline.diff
          git apply xoffline.diff

      - name: removeNewVersionNotif
        continue-on-error: true
        if: env.removeNewVersionNotif == 'true'
        shell: bash
        run: |
          sed -i -e 's|updateUrl.isNotEmpty|false|' ./flutter/lib/desktop/pages/desktop_home_page.dart
          sed -i '/let (request, url) =/,/Ok(())/{/Ok(())/!d}' ./src/common.rs

      # - name: run as admin
      #   continue-on-error: true
      #   if: ${{ env.runasadmin == 'true' }}
      #   shell: bash
      #   run: |
      #     sed -i '/<\/compatibility>/a \
      #           <security> \
      #             <requestedExecutionLevel level="requireAdministrator" uiAccess="false"/> \
      #           </security>' ./flutter/windows/runner/runner.exe.manifest

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "25% complete"}'

      - name: replace flutter icons
        if: ${{ env.iconlink_url != 'false' }}
        continue-on-error: true
        run: |
          cd ./flutter
          #flutter pub upgrade win32
          flutter pub get
          flutter pub run flutter_launcher_icons
          cd ..

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "50% complete, this step takes about 5 minutes, be patient."}'

      - name: Build rustdesk
        shell: powershell
        run: |
          # 1. Запуск сборки
          # На Windows обычно просто 'python', а не 'python3'
          python .\build.py --portable --hwcodec --flutter --vram --skip-portable-pack

          # Проверяем, создалась ли папка, прежде чем перемещать
          $BuildPath = ".\flutter\build\windows\x64\runner\Release"
          if (Test-Path -Path $BuildPath) {
              Move-Item -Path $BuildPath -Destination ".\rustdesk" -Force
          } else {
              Write-Error "Build failed! Output directory not found: $BuildPath"
              exit 1
          }

          # 2. Скачивание usbmmidd_v2
          $Url = "https://github.com/rustdesk-org/rdev/releases/download/usbmmidd_v2/usbmmidd_v2.zip"
          Invoke-WebRequest -Uri $Url -OutFile "usbmmidd_v2.zip"
          Expand-Archive "usbmmidd_v2.zip" -DestinationPath . -Force

          # Удаляем лишнее (с проверкой существования)
          if (Test-Path "usbmmidd_v2\Win32") { Remove-Item -Path "usbmmidd_v2\Win32" -Recurse -Force }
          $FilesToRemove = @("usbmmidd_v2\deviceinstaller64.exe", "usbmmidd_v2\deviceinstaller.exe", "usbmmidd_v2\usbmmidd.bat")
          foreach ($File in $FilesToRemove) {
              if (Test-Path $File) { Remove-Item -Path $File -Force }
          }

          Move-Item -Path ".\usbmmidd_v2" -Destination ".\rustdesk" -Force

          # 3. Драйвер принтера
          try {
            $BaseUrl = "https://github.com/rustdesk/hbb_common/releases/download/driver"
            Invoke-WebRequest -Uri "$BaseUrl/rustdesk_printer_driver_v4-1.4.zip" -OutFile "rustdesk_printer_driver_v4-1.4.zip"
            Invoke-WebRequest -Uri "$BaseUrl/printer_driver_adapter.zip" -OutFile "printer_driver_adapter.zip"
            Invoke-WebRequest -Uri "$BaseUrl/sha256sums" -OutFile "sha256sums"

            # Проверка хешей
            $checksum_driver = (Select-String -Path .\sha256sums -Pattern '^([a-fA-F0-9]{64}) \*rustdesk_printer_driver_v4-1.4\.zip$').Matches.Groups[1].Value
            $downloadsum_driver = (Get-FileHash -Path rustdesk_printer_driver_v4-1.4.zip -Algorithm SHA256).Hash

            $checksum_adapter = (Select-String -Path .\sha256sums -Pattern '^([a-fA-F0-9]{64}) \*printer_driver_adapter\.zip$').Matches.Groups[1].Value
            $downloadsum_adapter = (Get-FileHash -Path printer_driver_adapter.zip -Algorithm SHA256).Hash

            if ($checksum_driver -eq $downloadsum_driver -and $checksum_adapter -eq $downloadsum_adapter) {
                Write-Output "Checksums match. Extracting..."

                Expand-Archive rustdesk_printer_driver_v4-1.4.zip -DestinationPath . -Force
                $DriverDir = ".\rustdesk\drivers\RustDeskPrinterDriver"
                New-Item -ItemType Directory -Force -Path $DriverDir | Out-Null
                Move-Item -Path ".\rustdesk_printer_driver_v4-1.4" -Destination $DriverDir -Force

                Expand-Archive printer_driver_adapter.zip -DestinationPath . -Force
                Move-Item -Path ".\printer_driver_adapter.dll" -Destination ".\rustdesk" -Force
            } else {
                Write-Warning "Checksum mismatch! Skipping printer drivers."
            }
          } catch {
              Write-Warning "Printer driver download/install failed: $_"
              # Не прерываем сборку из-за драйвера принтера
          }

      - name: icon stuff
        if: ${{ env.iconlink_url != 'false' }}
        continue-on-error: true
        run: |
          mv ./rustdesk/data/flutter_assets/assets/icon.svg ./rustdesk/data/flutter_assets/assets/icon.svg.bak
          magick ./res/icon.png ./rustdesk/data/flutter_assets/assets/icon.svg

      - name: logo stuff
        if: ${{ env.logolink_url != 'false' }}
        continue-on-error: true
        run: |
          Invoke-WebRequest -Uri ${{ env.logolink_url }}/get_png?filename=${{ env.logolink_file }}"&"uuid=${{ env.logolink_uuid }} -OutFile ./rustdesk/data/flutter_assets/assets/logo.png

      - name: find Runner.res
        # Windows: find Runner.res (compiled from ./flutter/windows/runner/Runner.rc), copy to ./Runner.res
        # Runner.rc does not contain actual version, but Runner.res does
        continue-on-error: true
        shell: bash
        run: |
          runner_res=$(find . -name "Runner.res");
          if [ "$runner_res" == "" ]; then
            echo "Runner.res: not found";
          else
            echo "Runner.res: $runner_res";
            cp $runner_res ./libs/portable/Runner.res;
            echo "list ./libs/portable/Runner.res";
            ls -l ./libs/portable/Runner.res;
          fi

      - name: Download RustDeskTempTopMostWindow artifacts
        uses: actions/download-artifact@master
        if: env.UPLOAD_ARTIFACT == 'true'
        with:
          name: topmostwindow-artifacts
          path: "./rustdesk"

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "70% complete, this step takes about 5 minutes, be patient."}'

      - name: zip dlls
        continue-on-error: true
        shell: pwsh
        run: |
          Compress-Archive -Path ./rustdesk/*.dll, ./rustdesk/*.exe -DestinationPath ./rustdesk/unsigned_files.zip -CompressionLevel Fastest

      - name: sign dlls
        continue-on-error: true
        shell: bash
        run: |
          if [ ! -z "${{ secrets.SIGN_BASE_URL }}" ] && [ ! -z "${{ secrets.SIGN_API_KEY }}" ]; then
            curl -X POST -F "file=@./rustdesk/unsigned_files.zip" \
              -H "X-API-KEY: ${{ secrets.SIGN_API_KEY }}" \
              -m 900 \
              "${{ secrets.SIGN_BASE_URL }}/sign/" -o ./rustdesk/signed_files.zip
          else
            echo "Signing skipped - signing URL or API key not configured"
            cp ./rustdesk/unsigned_files.zip ./rustdesk/signed_files.zip
          fi

      - name: unzip dlls
        continue-on-error: true
        shell: pwsh
        run: |
          Expand-Archive -Path ./rustdesk/signed_files.zip -DestinationPath ./rustdesk/ -Force
          Remove-Item ./rustdesk/unsigned_files.zip
          Remove-Item ./rustdesk/signed_files.zip

      - name: Create custom.txt file
        shell: bash
        run: |
          echo -n "${{ env.custom }}" | cat > ./rustdesk/custom_.txt

      - name: Build self-extracted executable
        shell: bash
        if: env.UPLOAD_ARTIFACT == 'true'
        run: |
          mv "./rustdesk/rustdesk.exe" "./rustdesk/${{ env.appname }}.exe" || echo "rustdesk.exe"
          sed -i '/dpiAware/d' res/manifest.xml
          pushd ./libs/portable
          pip3 install -r requirements.txt
          python3 ./generate.py -f ../../rustdesk/ -o . -e "../../rustdesk/${{ env.appname }}.exe"
          popd
          mkdir -p ./SignOutput
          mv ./target/release/rustdesk-portable-packer.exe "./SignOutput/rustdesk.exe"

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Build msi
        continue-on-error: true
        if: env.UPLOAD_ARTIFACT == 'true'
        run: |
          $myappname = "${{ env.appname }}" -replace '\s','_'
          cp "rustdesk/${{ env.appname }}.exe" "rustdesk/${myappname}.exe" -ErrorAction SilentlyContinue
          pushd ./res/msi
          python preprocess.py --app-name "$myappname" --arp -d ../../rustdesk
          nuget restore msi.sln
          msbuild msi.sln -p:Configuration=Release -p:Platform=x64 /p:TargetVersion=Windows10
          cp ./Package/bin/x64/Release/en-us/Package.msi ../../SignOutput/rustdesk-latest.msi
          mv ./Package/bin/x64/Release/en-us/Package.msi ../../SignOutput/rustdesk.msi
          sha256sum ../../SignOutput/rustdesk.msi

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "85% complete"}'

      - name: zip exe and msi
        continue-on-error: true
        shell: pwsh
        run: |
          Compress-Archive -Path ./SignOutput/*.exe, ./SignOutput/*.msi -DestinationPath ./SignOutput/unsigned_files.zip -CompressionLevel Fastest

      - name: sign exe and msi
        continue-on-error: true
        shell: bash
        run: |
          if [ ! -z "${{ secrets.SIGN_BASE_URL }}" ] && [ ! -z "${{ secrets.SIGN_API_KEY }}" ]; then
            curl -X POST -F "file=@./SignOutput/unsigned_files.zip" \
              -H "X-API-KEY: ${{ secrets.SIGN_API_KEY }}" \
              -m 900 \
              "${{ secrets.SIGN_BASE_URL }}/sign/" -o ./SignOutput/signed_files.zip
          else
            echo "Signing skipped - signing URL or API key not configured"
            cp ./SignOutput/unsigned_files.zip ./SignOutput/signed_files.zip
          fi

      - name: unzip exe and msi
        continue-on-error: true
        shell: pwsh
        run: |
          Expand-Archive -Path ./SignOutput/signed_files.zip -DestinationPath ./SignOutput/ -Force
          Remove-Item ./SignOutput/unsigned_files.zip
          Remove-Item ./SignOutput/signed_files.zip

      - name: rename rustdesk.exe to filename.exe
        run: |
          mv ./SignOutput/rustdesk.exe "./SignOutput/${{ env.filename }}.exe" || echo "rustdesk"

      - name: rename rustdesk.msi to filename.msi
        continue-on-error: true
        run: |
          mv ./SignOutput/rustdesk.msi "./SignOutput/${{ env.filename }}.msi" || echo "rustdesk"

      - name: send file to rdgen server
        if: ${{ env.rdgen == 'true' }}
        shell: bash
        run: |
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./SignOutput/${{ env.filename }}.exe" -F "uuid=${{ env.uuid }}" ${{ secrets.GENURL }}/save_custom_client
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./SignOutput/${{ env.filename }}.msi" -F "uuid=${{ env.uuid }}" ${{ secrets.GENURL }}/save_custom_client || true

      - name: send file to api server
        if: ${{ env.rdgen == 'false' }}
        shell: bash
        run: |
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./SignOutput/${{ env.filename }}.exe" ${{ env.apiServer }}/api/save_custom_client
          curl -i -X POST -H "Content-Type: multipart/form-data" -H "Authorization: Bearer ${{ env.token }}" -F "file=@./SignOutput/${{ env.filename }}.msi" ${{ env.apiServer }}/api/save_custom_client || true

      - name: Report Status
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "Success"}'

      - name: failed
        if: failure()
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "Generation failed, try again"}'

      - name: failed
        if: cancelled()
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ env.uuid }}", "status": "Generation cancelled, try again"}'
